<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <link href="css/style.css" rel="stylesheet" />
</head>
<body>
    <div class="container">

        <div class="pop-dialog">

            <div class="pop-cont">
                <div class="h1">加入聊天</div>
                <div class="pop-form">
                    <div class="form-group">
                        <div class="form-flex">
                            <label>姓名：</label>
                            <div class="tfill">
                                <input type="text" class="form-control d_name" />
                            </div>
                        </div>

                    </div>
                    <div class="form-group">
                        <div class="form-flex">
                            <label>頭像：</label>
                            <div class="tfill">
                                <select class="form-control d_icon">
                                    <option value="people">預設</option>
                                    <option value="pig">豬</option>
                                    <option value="dog">狗</option>
                                    <option value="cat">貓</option>
                                    <option value="rabbit">兔</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="btn-group">
                            <a href="javascript:void(0);" class="btn btn-dark" onclick="close_window()">取消</a>
                            <a href="javascript:void(0);" class="btn btn-default" onclick="send_window()">確定</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="wrapper">



            <div class="content">



                <input type="hidden" id="displayname" />
                <input type="hidden" id="iconval" />
                <ul id="discussion">
                </ul>
            </div>
            <div class="fillform-area">
                <input type="text" id="message" />
                <input type="button" id="sendmessage" value="Send" />
            </div>
        </div>



        <!--<div id="notification"></div>-->
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-3.5.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.4.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--<script src="Scripts/iNotify.js"></script>-->
    <!--<script src="Scripts/iNotify-master/dist/notify.js"></script>-->
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            //授權
            if (Notification.permission === 'default' || Notification.permission === 'undefined') {
                //status 可為「granted」（同意）、「denied」（拒絕）和「default」（未授權）
                //使用者從未授權過（default）或 undefined（老舊瀏覽器的未知狀態）
                Notification.requestPermission(function (status) {
                    // This allows to use Notification.permission with Chrome/Safari
                    if (Notification.permission !== status) {
                        Notification.permission = status;
                    }
                });
            }


            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;
            //歷史
            chat.client.ChatHistory = function (history) {
                // Display chat history
                console.log(history);
                let arry = history;
                if (arry.length > 0) {
                    $('#discussion').empty();
                    arry.forEach(function (item) {
                        let _name = item.Sender;
                        let _msg = item.Message;
                        let _icon = item.Icon;
                        
                        $('#discussion').append(`<li>
                            <div class='peoplebox'>
                                <div class='icon-box'><div class='icon icon_${_icon}'></div></div>
                                <div class='name-box'>${_name}</div>
                            </div>
                            <div class='cont-box'>${_msg}</div>
                            </li>`);

                        //$('#discussion').append('<li><strong>' + _name
                        //    + '</strong>:&nbsp;&nbsp;' + _msg + '</li>');
                    });
                }


            };


            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastMessage = function (name, message,icon) {
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                var encodedIcon = "icon_" + icon;
                // Add the message to the page.
                $('#discussion').append(`<li>
                    <div class='peoplebox'>
                        <div class='icon-box'><div class='icon ${encodedIcon}'></div></div>
                        <div class='name-box'>${encodedName}</div>
                    </div>
                    <div class='cont-box'>${encodedMsg}</div>
                    </li>`);

                //$('#discussion').append('<li><strong>' + encodedName
                //    + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');

                //通知
                //if (window.document.hasFocus() == false) { //畫面未在網頁上
                var notification = new Notification(encodedName, { body: '通知RRR' });
                notification.onclick = function (event) {
                    // prevent the browser from focusing the Notification's tab
                    event.preventDefault();
                    parent.focus();
                    window.focus();
                }
                setTimeout(notification.close.bind(notification), 3000);
                //}

            };

            //chat.client.notify = function (message) {

            //    $('#notification').text(message).fadeIn().delay(8000).fadeOut();
            //};

            // Get the user name and store it to prepend to messages.
            //$('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {

                //歷史紀錄
                chat.server.getChatHistory();


                $('#sendmessage').click(function () {
                    let msg_val = $('#message').val();
                    console.log(msg_val);
                    if (msg_val.trim() != "") {
                        // Call the Send method on the hub.
                        chat.server.send($('#displayname').val(), $('#message').val(), $("#iconval").val());
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    } else {
                        alert("請輸入文字");
                    }

                });
            });

            $("#message").keyup(function (event) {
                if (event.keyCode === 13) {
                    $("#sendmessage").click();
                }
            });

        });

        function close_window() {
            $(".pop-dialog").remove();
        }
        function send_window() {
            let n_val = $(".d_name").val();
            if (n_val.trim() != "") {
                $("#displayname").val($(".d_name").val());
                $("#iconval").val($(".d_icon").find(":selected").val());

                $(".pop-dialog").remove();
            } else {
                alert("請輸入姓名");
            }
            
        }
    </script>
</body>
</html>